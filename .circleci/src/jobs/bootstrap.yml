executor: node
parameters:
  concurrency:
    type: integer
    default: 2
steps:
  - checkout
  - run: ./scripts/assert-changed-files.sh "packages/*|(e2e|integration)-tests/*|.circleci/*"
  - restore_cache:
      key: yarn-offline-cache-v0.0
  - restore_cache:
      key: monorepo-alldeppssssss-v0.0
  - node/install-packages:
      pkg-manager: yarn
      with-cache: false
      cache-name: monorepo-depsssssssssssssss
      cache-version: v2
      cache-path: ~/.cache/
  - save_cache:
      key: monorepo-alldeppssssss-v0.0
      paths:
        - node_modules/
        - packages/babel-plugin-remove-graphql-queries/node_modules/
        - packages/babel-preset-gatsby-package/node_modules/
        - packages/babel-preset-gatsby/node_modules/
        - packages/gatsby-admin/node_modules/
        - packages/gatsby-cli/node_modules/
        - packages/gatsby-codemods/node_modules/
        - packages/gatsby-core-utils/node_modules/
        - packages/gatsby-cypress/node_modules/
        - packages/gatsby-design-tokens/node_modules/
        - packages/gatsby-dev-cli/node_modules/
        - packages/gatsby-graphiql-explorer/node_modules/
        - packages/gatsby-image/node_modules/
        - packages/gatsby-legacy-polyfills/node_modules/
        - packages/gatsby-link/node_modules/
        - packages/gatsby-page-utils/node_modules/
        - packages/gatsby-plugin-benchmark-reporting/node_modules/
        - packages/gatsby-plugin-canonical-urls/node_modules/
        - packages/gatsby-plugin-catch-links/node_modules/
        - packages/gatsby-plugin-coffeescript/node_modules/
        - packages/gatsby-plugin-create-client-paths/node_modules/
        - packages/gatsby-plugin-cxs/node_modules/
        - packages/gatsby-plugin-emotion/node_modules/
        - packages/gatsby-plugin-facebook-analytics/node_modules/
        - packages/gatsby-plugin-feed/node_modules/
        - packages/gatsby-plugin-flow/node_modules/
        - packages/gatsby-plugin-fullstory/node_modules/
        - packages/gatsby-plugin-glamor/node_modules/
        - packages/gatsby-plugin-google-analytics/node_modules/
        - packages/gatsby-plugin-google-gtag/node_modules/
        - packages/gatsby-plugin-google-tagmanager/node_modules/
        - packages/gatsby-plugin-guess-js/node_modules/
        - packages/gatsby-plugin-jss/node_modules/
        - packages/gatsby-plugin-layout/node_modules/
        - packages/gatsby-plugin-less/node_modules/
        - packages/gatsby-plugin-lodash/node_modules/
        - packages/gatsby-plugin-manifest/node_modules/
        - packages/gatsby-plugin-mdx/node_modules/
        - packages/gatsby-plugin-netlify-cms/node_modules/
        - packages/gatsby-plugin-netlify/node_modules/
        - packages/gatsby-plugin-no-sourcemaps/node_modules/
        - packages/gatsby-plugin-nprogress/node_modules/
        - packages/gatsby-plugin-offline/node_modules/
        - packages/gatsby-plugin-page-creator/node_modules/
        - packages/gatsby-plugin-postcss/node_modules/
        - packages/gatsby-plugin-preact/node_modules/
        - packages/gatsby-plugin-preload-fonts/node_modules/
        - packages/gatsby-plugin-react-css-modules/node_modules/
        - packages/gatsby-plugin-react-helmet/node_modules/
        - packages/gatsby-plugin-remove-trailing-slashes/node_modules/
        - packages/gatsby-plugin-sass/node_modules/
        - packages/gatsby-plugin-schema-snapshot/node_modules/
        - packages/gatsby-plugin-sharp/node_modules/
        - packages/gatsby-plugin-sitemap/node_modules/
        - packages/gatsby-plugin-styled-components/node_modules/
        - packages/gatsby-plugin-styled-jsx/node_modules/
        - packages/gatsby-plugin-styletron/node_modules/
        - packages/gatsby-plugin-stylus/node_modules/
        - packages/gatsby-plugin-subfont/node_modules/
        - packages/gatsby-plugin-twitter/node_modules/
        - packages/gatsby-plugin-typescript/node_modules/
        - packages/gatsby-plugin-typography/node_modules/
        - packages/gatsby-react-router-scroll/node_modules/
        - packages/gatsby-recipes/node_modules/
        - packages/gatsby-remark-autolink-headers/node_modules/
        - packages/gatsby-remark-code-repls/node_modules/
        - packages/gatsby-remark-copy-linked-files/node_modules/
        - packages/gatsby-remark-custom-blocks/node_modules/
        - packages/gatsby-remark-embed-snippet/node_modules/
        - packages/gatsby-remark-graphviz/node_modules/
        - packages/gatsby-remark-images-contentful/node_modules/
        - packages/gatsby-remark-images/node_modules/
        - packages/gatsby-remark-katex/node_modules/
        - packages/gatsby-remark-prismjs/node_modules/
        - packages/gatsby-remark-responsive-iframe/node_modules/
        - packages/gatsby-remark-smartypants/node_modules/
        - packages/gatsby-source-contentful/node_modules/
        - packages/gatsby-source-drupal/node_modules/
        - packages/gatsby-source-faker/node_modules/
        - packages/gatsby-source-filesystem/node_modules/
        - packages/gatsby-source-graphql/node_modules/
        - packages/gatsby-source-hacker-news/node_modules/
        - packages/gatsby-source-lever/node_modules/
        - packages/gatsby-source-medium/node_modules/
        - packages/gatsby-source-mongodb/node_modules/
        - packages/gatsby-source-npm-package-search/node_modules/
        - packages/gatsby-source-shopify/node_modules/
        - packages/gatsby-source-wikipedia/node_modules/
        - packages/gatsby-source-wordpress/node_modules/
        - packages/gatsby-telemetry/node_modules/
        - packages/gatsby-theme/node_modules/
        - packages/gatsby-transformer-asciidoc/node_modules/
        - packages/gatsby-transformer-csv/node_modules/
        - packages/gatsby-transformer-documentationjs/node_modules/
        - packages/gatsby-transformer-excel/node_modules/
        - packages/gatsby-transformer-hjson/node_modules/
        - packages/gatsby-transformer-javascript-frontmatter/node_modules/
        - packages/gatsby-transformer-javascript-static-exports/node_modules/
        - packages/gatsby-transformer-json/node_modules/
        - packages/gatsby-transformer-pdf/node_modules/
        - packages/gatsby-transformer-react-docgen/node_modules/
        - packages/gatsby-transformer-remark/node_modules/
        - packages/gatsby-transformer-screenshot/node_modules/
        - packages/gatsby-transformer-sharp/node_modules/
        - packages/gatsby-transformer-sqip/node_modules/
        - packages/gatsby-transformer-toml/node_modules/
        - packages/gatsby-transformer-xml/node_modules/
        - packages/gatsby-transformer-yaml/node_modules/
        - packages/gatsby/node_modules/
  - save_cache:
      paths:
        - ./.yarn/yarn-offline-cache/
      key: yarn-offline-cache-v0.0
  - run:
      name: Build monorepo
      command: yarn bootstrap -- concurrency=<< parameters.concurrency >> --stream
  # Persist the workspace with all packages already built
  - persist_to_workspace:
      root: ./
      paths:
        - "packages/"
        - "node_modules"
